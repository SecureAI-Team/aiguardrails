worker_processes 1;
events { worker_connections 1024; }

http {
  upstream llm_upstream {
    server upstream-llm:443;
  }

  server {
    listen 8443 ssl;
    ssl_certificate     /etc/nginx/certs/proxy.crt;
    ssl_certificate_key /etc/nginx/certs/proxy.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Pre-flight: prompt check
    location /api/prompt-check {
      proxy_pass http://api:8080/v1/guardrails/prompt-check;
      proxy_set_header X-App-Id $http_x_app_id;
      proxy_set_header X-App-Secret $http_x_app_secret;
      proxy_set_header Content-Type "application/json";
    }

    # Pre-flight: output filter
    location /api/output-filter {
      proxy_pass http://api:8080/v1/guardrails/output-filter;
      proxy_set_header X-App-Id $http_x_app_id;
      proxy_set_header X-App-Secret $http_x_app_secret;
      proxy_set_header Content-Type "application/json";
    }

    # Upstream pass-through (example)
    location /llm {
      proxy_set_header X-App-Id $http_x_app_id;
      proxy_set_header X-App-Secret $http_x_app_secret;
      proxy_pass https://upstream-llm;
    }
  }
}

